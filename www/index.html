<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <!--meta name="viewport" content="width=device-width"-->
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, target-densityDpi=device-dpi" />
  
  <meta http-equiv="cache-control" content="no-cache, must-revalidate, post-check=0, pre-check=0">
  <meta http-equiv="expires" content="Sat, 31 Oct 2014 00:00:00 GMT">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="Content-Security-Policy" content="default-src * 'self' data: gap://ready data:* 'unsafe-inline' 'unsafe-eval' file: gap: gap://* ">  
  
  <title>RoundTheCans</title>

  <script src="cordova.js"></script>
  
   
  <script src="https://www.gstatic.com/firebasejs/5.4.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.4.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.4.1/firebase-firestore.js"></script>
  
  <script src="https://cdn.firebase.com/libs/firebaseui/3.4.0/firebaseui.js"></script>
  <link type="text/css" rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/3.4.0/firebaseui.css" />
  
   
 <script src="https://cdnjs.cloudflare.com/ajax/libs/hellojs/2.0.0-4/hello.all.js"></script> 

  
</head>


<style>
 body {margin: 0}
 #MyIframe {width: 100vw; border:none; height:100vh;  ZZposition:absolute; ZZtop:0}
 #MyMainDiv {position:relative}
 #LoadingScreen {font-size:200%; text-align:center; position:absolute; top:0}
 </style>
 
 
<body onload="BodyLoaded()">
<button onclick="reload()"> RELOAD</button>
<label><input id=LoadLocal type=checkbox style="transform:scale(1.7)"> LOCAL </label> &nbsp;
<button onclick="BeGone()"> EXIT</button>
<button onclick="test()"> TEST</button>
<button onclick="BackgroundGeolocation.showAppSettings()"> SHOW1</button>
<button onclick="BackgroundGeolocation.showLocationSettings()"> SHOW2</button>
<div id="firebaseui-auth-container">Logon here</div>


 <br>

 <div id=MyMainDiv> 
	<div id=LoadingScreen> APP <p>IS <p>LOADING</div>
	<iframe id=MyIframe allow='geolocation; camera' XXsrc="subindex.html"></iframe>
	</div>

<!--Script src="token.js"></script-->	
<script>

var CW;
var GPS;
var background = false;

//window.onerror = function (msg, url, line, col, err) {console.log("error line ", line," " + msg); zz.innerHTML = msg + "<br>" + zz.innerHTML};

var isrc = "http://localhost:8080/www/subindex.html";
var isrc_L = "subindex.html";
var isrc_R = "https://firebasestorage.googleapis.com/v0/b/roundthecans-1a.appspot.com/o/subindex.html?alt=media";

isrc = isrc_L;
if (location.href.split("/")[4] == "Work") {
	LoadLocal.checked = true;
	}
	
function BeGone() {
	if (!navigator) alert('No Nav');
	if (!navigator.app) alert('No App');
	navigator.app.exitApp();
	}

	
function test() {
	send("LOG", {o:"yeppers"});
	}
	
	
function StartGPS () {
	if (device.platform == "Debug") {
		GPS = navigator.geolocation.watchPosition(function (p) {
				send("GPS", p.coords)}, null, {enableHighAccuracy: true
				} );
		return
		}

	BackgroundGeolocation.configure({
		locationProvider: BackgroundGeolocation.DISTANCE_FILTER_PROVIDER,
		desiredAccuracy: BackgroundGeolocation.MEDIUM_ACCURACY,
		stationaryRadius: 10,
		distanceFilter: 10,
		startForeground: false,
		stopOnTerminate: true,
		notificationTitle: 'Background position reporting',
		notificationText: 'enabled',
		debug: false,                         //********************
		interval: 10000,
		fastestInterval: 5000,
		activitiesInterval: 10000
		});	
		
	BackgroundGeolocation.on('location', function(location) {
			location.mode = (background) ? "bg" : "fg";
			location.MyTime = (new Date()).getTime();
			send("GPS", cloneAsObject(location));
			});
		  
		  
	BackgroundGeolocation.on('background', function() {
			send("LOG", {o:"[BACKGROUND]"});
			background = true;
			});

	BackgroundGeolocation.on('foreground', function() {
			send("LOG", {o:"[FOREGROUND]"});
			background = false;
			});
	
	
	BackgroundGeolocation.on('error', function(error) {
		send("LOG", {o:"[ERROR] " + error.code + " " + error.message});
		});

	BackgroundGeolocation.on('start', function() {
		send("LOG", {o:"[START]"});
	  });

	BackgroundGeolocation.on('stop', function() {
		send("LOG", {o:"[STOP]"});
	  });

	BackgroundGeolocation.on('authorization', function(status) {
		send("LOG", {o:"[AUTH]"});
		if (status !== BackgroundGeolocation.AUTHORIZED) {
		  // we need to set delay or otherwise alert may not be shown
		  setTimeout(function() {
			var showSettings = confirm('App requires location tracking permission. Would you like to open app settings?');
			if (showSetting) {
			  return BackgroundGeolocation.showAppSettings();
			}
		  }, 1000);
		}
	  });

		
	BackgroundGeolocation.start();  
	
	if (device.platform != "ZZAndroid") {
		send("LOG", {o:"[WatchPos]"});
		navigator.geolocation.watchPosition(
			function (p) {
				p = cloneAsObject(p.coords);
				p.mode = "wp";
				p.MyTime = (new Date()).getTime();
				send("GPS", p);
				}, 
			function (e) {
				send("LOG", "WatchError");
				send("LOG", JSON.stringify(e));
				},
			{enableHighAccuracy:true});
		}
	}	

	
function StopGPS () {
	if (device.platform == "Debug") navigator.geolocation.clearWatch(GPS);
		else BackgroundGeolocation.stop();  
	}

	


	

function reload() {
	isrc = (LoadLocal.checked) ? isrc_L : isrc_R;
    LoadingScreen.style.display="block";	
	if (GPS) navigator.geolocation.clearWatch(GPS);
	GPS= null;
	
	el=document.createElement("IFRAME");
	el.allow= "geolocation; camera";
	MyMainDiv.removeChild(MyMainDiv.querySelector("#MyIframe"));
	el.id="MyIframe";
	MyMainDiv.appendChild(el);
	
	if (isrc.substr(0,4) == "http") {
		fetch(isrc)
			.then(function(r) {return r.text()})
			.then(function(t) {document.getElementById("MyIframe").srcdoc = t;}); 
		}
		
	else {	
		setTimeout(function () {document.getElementById("MyIframe").src= isrc}, 50);
		}
	}
	
	
function cloneAsObject(obj) {
    if (obj === null || !(obj instanceof Object)) { return obj; }
    var temp = (obj instanceof Array) ? [] : {};
    for (var key in obj) { temp[key] = cloneAsObject(obj[key]); }
    return temp;
	}	
	
function send (msg, obj) {
    if (!obj) obj = {};
	obj.msg = msg;
	if (CW) CW.postMessage(JSON.stringify(cloneAsObject(obj)), "*");
	}	
	
	

	
document.addEventListener('deviceready', deviceIsReady);

function BodyLoaded() {
	addEventListener("message", gotMessage);
	if (!window.cordova) {
		device= {platform:"Debug"};
		deviceIsReady();
		}
	}
	
function deviceIsReady () {
    console.log("Devready");
	if (device.platform == "Android" && cordova && cordova.plugins && cordova.plugins.permissions) {
		cordova.plugins.permissions.requestPermissions([cordova.plugins.permissions.ACCESS_COARSE_LOCATION,
														cordova.plugins.permissions.ACCESS_FINE_LOCATION,
														cordova.plugins.permissions.CAMERA],
														null, null);
		}
		

	reload();	
	}
	
	
	
function gotMessage(event) {
 console.log("GOT ", event.data)
  var dat= JSON.parse(event.data)
  var msg= dat.msg;
  if (msg == "STARTGPS") StartGPS();
  if (msg == "STOPGPS") StopGPS();
  if (msg == "FRAMELOADED") {
		console.log("Frame ready")
		LoadingScreen.style.display="none";	
	    CW = document.getElementById("MyIframe").contentWindow;
		send("ENV", {platform: device.platform, 
					 uuid: device.uuid,
					 model: device.model,
					 manufacturer: device.manufacturer,
					 serial: device.serial,
					 baseDir: location.href.split("/").slice(0,-1).join("/") + "/",
					 appDir: (!!window.cordova) ? cordova.file.applicationDirectory : ""
					 });  
		}
		
  if (msg == "CONSOLE") {
		console.log("Frame-> " + dat.o, dat);
		}
  if (msg == "LOGON") {
		Do_Logon();
		}
		

  }
  
  
  
var config = {
		apiKey: "AIzaSyBM_FfMEWgh78yEf-DQuPeK0E1Sd9GArHg",
		authDomain: "roundthecans-1a.firebaseapp.com",
		databaseURL: "https://roundthecans-1a.firebaseio.com",
		projectId: "roundthecans-1a",
		storageBucket: "roundthecans-1a.appspot.com",
		messagingSenderId: "973593662601"
	  };

function Do_Logon_Hello () {
// disallowed for google
    var p = 'google';
	console.log('about to init')
	hello.init({
                google : '973593662601-nqnt7ak9b62d15t13inkiqlq3khqejg6.apps.googleusercontent.com',
                facebook : '238895966823295'
            }, {
                //
                // Define the OAuth2 return URL
                // This can be anything you like, as long as its the callback associated with the your provider-app client id.
                // It could even be localhost, e.g. http://localhost/somepath as phonegap is not run from a domain so SameOrigin breaks, instead we take advantage of being able to read the popups URL in PhoneGap
                redirect_uri : 'https://davies2.com/oauth.html'
            });
   console.log('after init')
   console.log(hello.getAuthResponse(p)); // current state
   hello(p).login().then(function(r) {
                    console.log(r);
					hello(p).api('/me').then(function (resp) {console.log(resp)})  //resp.id is me !

                })
}
	  
  
function Do_Logon() {
firebase.initializeApp(config);

var provider = new firebase.auth.FacebookAuthProvider();
firebase.auth().signInWithRedirect(provider).then(function(result) {
  // This gives you a Facebook Access Token. You can use it to access the Facebook API.
  console.log(result)
  var token = result.credential.accessToken;
  // The signed-in user info.
  var user = result.user;
  // ...
}).catch(function(error) {
  // Handle Errors here.
  console.log(error)
  var errorCode = error.code;
  var errorMessage = error.message;
  // The email of the user's account used.
  var email = error.email;
  // The firebase.auth.AuthCredential type that was used.
  var credential = error.credential;
  // ...
});

return 

var ui = new firebaseui.auth.AuthUI(firebase.auth());
ui.start('#firebaseui-auth-container', {
  callbacks : {
  signInWithPopup: function(authResult, redirectUrl) {console.log("Success ", authResult)},
  //signInSuccessWithAuthResult: function(authResult, redirectUrl) {log("Success")},
  uiShown: function() {}
  
  },
  signInOptions: [
    firebase.auth.EmailAuthProvider.PROVIDER_ID,
    firebase.auth.GoogleAuthProvider.PROVIDER_ID,
    firebase.auth.FacebookAuthProvider.PROVIDER_ID
  ],
  // Other config options...
});
}
 
  
	
  </script>
  


</body>
</html>