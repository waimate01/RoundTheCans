<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <!--meta name="viewport" content="width=device-width"-->
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, target-densityDpi=device-dpi" />
  
  <meta http-equiv="cache-control" content="no-cache, must-revalidate, post-check=0, pre-check=0">
  <meta http-equiv="expires" content="Sat, 31 Oct 2014 00:00:00 GMT">
  <meta http-equiv="pragma" content="no-cache">

  <title>RoundTheCans</title>

  <script src="cordova.js"></script>

</head>


<style>
 body {margin: 0}
 #MyIframe {width: 100vw; border:none; height:100vh;  position:absolute; top:0}
 #MyMainDiv {position:relative}
 #LoadingScreen {font-size:200%; text-align:center; position:absolute; top:0}
 </style>
 
 
<body onload="reload()">
<button onclick="reload()"> RELOAD</button>
<button onclick="BeGone()"> EXIT</button>
<button onclick="report()"> REPORT</button>
<div id=zz></div>
 <br><hr>

 <div id=MyMainDiv> 
	<div id=LoadingScreen> APP <p>IS <p>LOADING</div>
	<iframe id=MyIframe allow='geolocation; camera'></iframe>
	</div>

<script>


var CW;
var GPS;
var Platform; 

//window.onerror = function (msg, url, line, col, err) {console.log("error line ", line," " + msg); zz.innerHTML = msg + "<br>" + zz.innerHTML};

var isrc = "http://localhost:8080/www/subindex.html";
var isrc = "subindex.html";
if (location.href.split("/")[4] != "Work") {
	// running on device, fetch subindex from bucket
	var isrc = "https://firebasestorage.googleapis.com/v0/b/roundthecans-1a.appspot.com/o/subindex.html?alt=media";
	}
console.log("isrc=", isrc)	
	
function BeGone() {
	if (!navigator) alert('No Nav');
	if (!navigator.app) alert('No App');
	navigator.app.exitApp();
	}


function reload() {
	console.log("doing reload");
	zz.innerHTML = ""
    LoadingScreen.style.display="block";	
	if (GPS) navigator.geolocation.clearWatch(GPS);
	GPS= null;
	MyIframe.src= "";
	console.log("About to set timeout")
	setTimeout(function () {console.log("Loading src"); MyIframe.src= isrc}, 50);
	}
	
	
function cloneAsObject(obj) {
    if (obj === null || !(obj instanceof Object)) { return obj; }
    var temp = (obj instanceof Array) ? [] : {};
    for (var key in obj) { temp[key] = cloneAsObject(obj[key]); }
    return temp;
}	
	
function send (msg, obj) {
	console.log("request for parent to send "+msg);
    if (!obj) obj = {};
	obj.msg = msg;
	console.log("CW=", CW, " deets=", JSON.stringify(cloneAsObject(obj)))
	if (CW) CW.postMessage(JSON.stringify(cloneAsObject(obj)), "*");
	}	
	
	
function report() {
		LoadingScreen.style.display="none";	
	    CW = document.getElementById("MyIframe").contentWindow;

	send("LOG", {o:"yeppers"});
	}	


addEventListener('deviceready', function () {
	console.log("DeviceReady");
    Platform="Debug";
	if (device) {
			console.log("attempting to access device object")
			Platform = device.platform;
			}
	console.log("platform is ", platform)

	if (Platform == "Android" && cordova && cordova.plugins && cordova.plugins.permissions) {
		cordova.plugins.permissions.requestPermissions([cordova.plugins.permissions.ACCESS_COARSE_LOCATION,
														cordova.plugins.permissions.ACCESS_FINE_LOCATION,
														cordova.plugins.permissions.CAMERA],
														null, null);
		}
	});
	
	
addEventListener("message", function(event) {

  var dat= JSON.parse(event.data)
  var msg= dat.msg;
  if (msg == "FRAMELOADED") {
		LoadingScreen.style.display="none";	
	    CW = document.getElementById("MyIframe").contentWindow;
		send("ENV", {platform: Platform; basedir: location.href.split("/").slice(0,-1).join("/") + "/"});  
		}
  if (msg == "STARTWATCH") {
		console.log("Start watch")
		GPS = navigator.geolocation.watchPosition(function (p) {send("GPS", p.coords)},
											null,
											{enableHighAccuracy: true}
											);
		}
  if (msg == "ENDWATCH") {
		navigator.geolocation.clearWatch(GPS);
		}

  });
	
  </script>
  


</body>
</html>