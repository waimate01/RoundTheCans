<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <!--meta name="viewport" content="width=device-width"-->
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, target-densityDpi=device-dpi" />
  
  <meta http-equiv="cache-control" content="no-cache, must-revalidate, post-check=0, pre-check=0">
  <meta http-equiv="expires" content="Sat, 31 Oct 2014 00:00:00 GMT">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="Content-Security-Policy" content="default-src * 'self' data: gap://ready data:* 'unsafe-inline' 'unsafe-eval' file: gap: gap://* ">  
  
  <title>RoundTheCans</title>

  <script src="cordova.js"></script>

</head>


<style>
 body {margin: 0}
 #MyIframe {width: 100vw; border:none; height:100vh;  ZZposition:absolute; ZZtop:0}
 #MyMainDiv {position:relative}
 #LoadingScreen {font-size:200%; text-align:center; position:absolute; top:0}
 </style>
 
 
<body onload="BodyLoaded()">
<button onclick="reload()"> RELOAD</button>
<label><input id=LoadLocal type=checkbox style="transform:scale(1.7)"> LOCAL </label> &nbsp;
<button onclick="BeGone()"> EXIT</button>
<button onclick="test()"> TEST</button>
 <br>

 <div id=MyMainDiv> 
	<div id=LoadingScreen> APP <p>IS <p>LOADING</div>
	<iframe id=MyIframe allow='geolocation; camera' XXsrc="subindex.html"></iframe>
	</div>

<!--Script src="token.js"></script-->	
<script>

var CW;
var GPS;

//window.onerror = function (msg, url, line, col, err) {console.log("error line ", line," " + msg); zz.innerHTML = msg + "<br>" + zz.innerHTML};

var isrc = "http://localhost:8080/www/subindex.html";
var isrc_L = "subindex.html";
var isrc_R = "https://firebasestorage.googleapis.com/v0/b/roundthecans-1a.appspot.com/o/subindex.html?alt=media";

isrc = isrc_L;
if (location.href.split("/")[4] == "Work") {
	LoadLocal.checked = true;
	}
	
function BeGone() {
	if (!navigator) alert('No Nav');
	if (!navigator.app) alert('No App');
	navigator.app.exitApp();
	}

	
function test() {

	send("LOG", {o:"yeppers"});
	console.log("Requesting")
	BackgroundGeolocation.configure({
		locationProvider: BackgroundGeolocation.RAW_PROVIDER,
		desiredAccuracy: BackgroundGeolocation.HIGH_ACCURACY,
		stationaryRadius: 20,
		distanceFilter: 10,
		startForeground: false,
		notificationTitle: 'Background tracking',
		notificationText: 'enabled',
		//debug: true,
		fastestInterval: 5000,
		activitiesInterval: 10000
		});	


	BackgroundGeolocation.on('location', function(location) {
		console.log("LOC", location)

		send("GPS", cloneAsObject(location));
  		});
  	  
  BackgroundGeolocation.on('error', function(error) {
    console.log('[ERROR] BackgroundGeolocation error:', error.code, error.message);
  });

  BackgroundGeolocation.on('start', function() {
    console.log('[INFO] BackgroundGeolocation service has been started');
  });

  BackgroundGeolocation.on('stop', function() {
    console.log('[INFO] BackgroundGeolocation service has been stopped');
  });
	  
BackgroundGeolocation.on('background', function() {
    console.log('[INFO] App is in background');
    // you can also reconfigure service (changes will be applied immediately)
    BackgroundGeolocation.configure({ debug: true });
  });

  BackgroundGeolocation.on('foreground', function() {
    console.log('[INFO] App is in foreground');
    BackgroundGeolocation.configure({ debug: false });
  });

BackgroundGeolocation.start();  
	}	
	

function reload() {
	isrc = (LoadLocal.checked) ? isrc_L : isrc_R;
    LoadingScreen.style.display="block";	
	if (GPS) navigator.geolocation.clearWatch(GPS);
	GPS= null;
	
	el=document.createElement("IFRAME");
	el.allow= "geolocation; camera";
	MyMainDiv.removeChild(MyMainDiv.querySelector("#MyIframe"));
	el.id="MyIframe";
	MyMainDiv.appendChild(el);
	
	if (isrc.substr(0,4) == "http") {
		fetch(isrc)
			.then(function(r){
				return r.text()})
			.then(function(t) {document.getElementById("MyIframe").srcdoc = t;}); 
		}
		
	else {	
		setTimeout(function () {document.getElementById("MyIframe").src= isrc}, 50);
		}
	}
	
	
function cloneAsObject(obj) {
    if (obj === null || !(obj instanceof Object)) { return obj; }
    var temp = (obj instanceof Array) ? [] : {};
    for (var key in obj) { temp[key] = cloneAsObject(obj[key]); }
    return temp;
	}	
	
function send (msg, obj) {
    if (!obj) obj = {};
	obj.msg = msg;
	if (CW) CW.postMessage(JSON.stringify(cloneAsObject(obj)), "*");
	}	
	
	

	
document.addEventListener('deviceready', deviceIsReady);

function BodyLoaded() {
	addEventListener("message", gotMessage);
	if (!window.cordova) {
		device= {platform:"Debug"};
		deviceIsReady();
		}
	}
	
function deviceIsReady () {
    console.log("Devready");
	if (device.platform == "Android" && cordova && cordova.plugins && cordova.plugins.permissions) {
		cordova.plugins.permissions.requestPermissions([cordova.plugins.permissions.ACCESS_COARSE_LOCATION,
														cordova.plugins.permissions.ACCESS_FINE_LOCATION,
														cordova.plugins.permissions.CAMERA],
														null, null);
		}
		

	reload();	
	}
	
	
	
function gotMessage(event) {

  var dat= JSON.parse(event.data)
  var msg= dat.msg;
  if (msg == "FRAMELOADED") {
		console.log("Frame ready")
		LoadingScreen.style.display="none";	
	    CW = document.getElementById("MyIframe").contentWindow;
		send("ENV", {platform: device.platform, 
					// MyKey: MyKey,
					 uuid: device.uuid,
					 model: device.model,
					 manufacturer: device.manufacturer,
					 serial: device.serial,
					 baseDir: location.href.split("/").slice(0,-1).join("/") + "/",
					 appDir: (!!window.cordova) ? cordova.file.applicationDirectory : ""
					 });  
		//GPS = navigator.geolocation.getCurrentPosition(function (p) {console.log('got',p);send("GPS", p.coords)});
		//GPS = navigator.geolocation.watchPosition(function (p) {console.log('watched',p);send("GPS", p.coords)}, null, {enableHighAccuracy: true} );
		}
		
  if (msg == "CONSOLE") {
		console.log("Frame-> " + dat.o, dat);
		}
		

  }
	
  </script>
  


</body>
</html>